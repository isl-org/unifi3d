# @package _global_

# to execute this experiment with single GPU run:
# accelerate launch scripts/accelerate/acc_train.py experiment=acc_shape2vecset_ae


defaults:
  - override /net_encode: shape2vecset_ae
  - override /data: shape2vec
  - override /model: shape2vec_ae_trainer
  - override /trainer: default
  - override /logger: aim     # default is null.

# all parameters below will be merged with parameters from default configurations set above
# this allows you to overwrite only specified parameters

tags: ["train", "shape2vecset", "ae"]
seed: 12345
experiment_name: "acc_shape2vecset_ae_chair"

# # resume training from checkpoint
# ckpt_path: path/to/ckpt
# resume_training: True

logger: 
  aim: # Should be the same as /logger
    config: 
      loggers: ["metric", "image", "mesh", "hparams"] # List and type of logging implementations 
      tracked_variables: # The keys should match aim/loggers
        metric: ["loss", "lr"]
        image: ["render_rec", "render_gt"]
        mesh: ["mesh_rec", "mesh_gt"]

net_encode:
  layer_norm_encoding: true
  clamp_encoding: true
  density_grid_points: 64 # this is the res for decoding at inference time. set low to enable inference with higher bs

# define main parameters here because they are used in multiple places
learning_rate: 0.00001
n_epochs: 8000

model:
  net: ${net_encode}
  optimizer:
    lr: ${learning_rate}
  scheduler:
    _target_: torch.optim.lr_scheduler.LambdaLR
    lr_lambda:
      _target_: unifi3d.utils.scheduler.lambda_lr_utils.get_lambda_warmup_decay
      warmup_epochs: 20
      min_lr: 0.000001 # 1e-6
      max_lr: ${learning_rate}
      max_epoch: ${n_epochs}
    _partial_: true

data:
  batch_size: 8
  dataset:
    _target_: unifi3d.data.data_iterators.ShapenetPreprocessedIterator
    path: ${paths.shapenet_preprocessed_dir}
    categories:
      - "chair"
    mode: "train"
  val_dataset:
    _target_: unifi3d.data.data_iterators.ShapenetPreprocessedIterator
    path: ${paths.shapenet_preprocessed_dir}
    categories:
      - "chair"
    mode: "val"
  test_dataset:
    _target_: unifi3d.data.data_iterators.ShapenetPreprocessedIterator
    path: ${paths.shapenet_preprocessed_dir}
    categories:
      - "chair"
    mode: "test"

trainer:
  max_epochs: ${n_epochs}
  log_every_n_iter: 10
  log_image_every_n_iters: -1
  check_val_every_n_epoch: -1
  save_checkpoint_every_n_epoch: 10
  batch_post_process: null

paths:
  log_dir: ${paths.root_dir}/logs/${experiment_name}

test: false
